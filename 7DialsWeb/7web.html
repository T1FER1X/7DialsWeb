<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>~ * ~ 7DialsWeb: –û–ù–õ–ê–ô–ù –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† –ò –ß–ê–¢ ~ * ~</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* –û–±—â–∏–π —Å—Ç–∏–ª—å (–ì–µ–æ—Å–∏—Ç–∏—Å) */
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            color: #ffffff;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #000080; 
            animation: bg-flash 5s infinite alternate; 
            padding-bottom: 50px; 
        }
        @keyframes bg-flash {
            0% { background-color: #000080; } 
            33% { background-color: #800080; } 
            66% { background-color: #008080; } 
            100% { background-color: #000080; }
        }
        * {
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewport='0 0 100 100' style='fill:black;font-size:16px;'><text y='50%'>‚ú®</text></svg>") 16 16, auto;
        }
        /* –ì–ª–∞–≤–Ω—ã–π –±–∞–Ω–Ω–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω */
        .header-banner {
            background-color: #ff00ff;
            color: #00ffff;
            border: 5px dashed #ffff00;
            padding: 10px;
            text-shadow: 3px 3px 0 #000000;
            animation: blink 1s infinite;
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 20px;
        }
        @keyframes blink {
            0% { border-color: #ffff00; }
            50% { border-color: #ff00ff; }
            100% { border-color: #ffff00; }
        }
        .main-wrapper {
            display: flex;
            max-width: 1000px;
            margin: 0 auto;
            border: 5px groove #c0c0c0; 
            background-color: #008000;
            min-height: 70vh;
        }
        .sidebar {
            width: 200px;
            background-color: #c0c0c0;
            border-right: 3px solid #000000;
            padding: 10px;
            text-align: left;
            flex-shrink: 0;
        }
        .sidebar h3 { color: #000080; border-bottom: 2px solid #000080; padding-bottom: 5px; margin-top: 0; }
        .sidebar button {
            display: block; width: 100%; margin-bottom: 8px; padding: 10px 5px;
            background-color: #00ffff; color: #000080; border: 3px outset #000000;
            font-weight: bold; font-size: 14px; transition: background-color 0.1s, transform 0.05s;
        }
        .sidebar button:active { transform: translateY(1px); border-style: inset; }
        .sidebar button.active { background-color: #ffff00; border-style: inset; }
        .main-content {
            flex-grow: 1; padding: 20px; color: #ffffff; text-align: left;
        }
        .game-section {
            display: none; border: 4px dashed #ff0000; padding: 15px; margin-bottom: 20px; background-color: rgba(0, 0, 0, 0.3);
        }
        .game-section.active { display: block; }
        h2 { color: #ffff00; border-bottom: 2px dotted #ffff00; padding-bottom: 5px; margin-top: 0; font-size: 24px; }
        button {
            padding: 8px 15px; margin: 5px; background-color: #ff9900; color: #000000;
            border: 3px outset #000000; font-weight: bold; cursor: pointer;
        }
        .result {
            margin-top: 15px; padding: 10px; border: 2px solid #ff0000;
            background-color: #800080; color: #ffffff; font-weight: bold;
        }
        .gif-decoration { display: inline-block; margin: 0 5px; font-size: 24px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ö—Ä–µ—Å—Ç–∏–∫–æ–≤-–ù–æ–ª–∏–∫–æ–≤ (–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä) */
        #tictactoe-board {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-template-rows: repeat(3, 80px);
            width: 240px;
            height: 240px;
            margin: 20px auto;
            border: 6px solid #ffff00;
            background-color: #008000;
        }
        .cell {
            border: 3px solid #ffff00; font-size: 50px; text-align: center;
            line-height: 70px; cursor: pointer; user-select: none; transition: background-color 0.1s;
        }
        .cell:hover:not(.occupied) { background-color: rgba(255, 255, 0, 0.2); }
        .cell.win { background-color: #ff0000; color: #ffffff; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ß–ê–¢–ê */
        #chat-window {
            height: 300px;
            border: 3px solid #00ffff;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #000000;
            text-align: left;
            font-size: 14px;
        }
        .chat-message {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        .chat-message strong {
            color: #ffff00;
        }
        .chat-timestamp {
            font-size: 10px;
            color: #808080;
            float: right;
        }

        /* –†–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä */
        .ad-banner {
            position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ff0000; 
            color: #ffff00; padding: 10px 0; font-weight: bold; font-size: 18px;
            border-top: 5px solid #000000; text-shadow: 2px 2px 0 #000000;
            cursor: pointer; animation: ad-move 10s infinite linear; z-index: 1000;
        }
        @keyframes ad-move {
            0% { transform: translateX(0); }
            50% { transform: translateX(-5%); }
            100% { transform: translateX(0); }
        }

    </style>
</head>
<body>

    <div class="header-banner">
        ! 7DIALSWEB: –û–ù–õ–ê–ô–ù –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø !
    </div>
    
    <div class="main-wrapper">
        
        <aside class="sidebar">
            <h3>–ú–µ–Ω—é –ò–≥—Ä <span class="gif-decoration">üëæ</span></h3>
            <button data-target="home" class="active">üè† –ì–ª–∞–≤–Ω–∞—è –°—Ç—Ä–∞–Ω–∏—Ü–∞</button>
            <button data-target="tictactoe_game">‚öîÔ∏è –û–Ω–ª–∞–π–Ω –ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏</button>
            <button data-target="rps_game">‚úÇÔ∏è –ö–∞–º–µ–Ω—å/–ù–æ–∂–Ω–∏—Ü—ã (–õ–æ–∫.)</button>
            <button data-target="reaction_test">‚ö° –ö–ª–∏–∫-–¢–µ—Å—Ç (–õ–æ–∫.)</button>
            <button data-target="online_chat">üí¨ –§–æ—Ä—É–º–Ω—ã–π –ß–∞—Ç</button>
            
            <h3 style="margin-top: 15px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ó–≤—É–∫–æ–º</h3>
            <button id="toggleMusicButton">üîä –í–∫–ª. –ú—É–∑—ã–∫—É</button>
        </aside>
        
        <main class="main-content">
            
            <div id="home" class="game-section active">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ 7DialsWeb! <span class="gif-decoration">‚≠ê</span></h2>
                <p>–ü—Ä–∏–≤–µ—Ç! –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å **–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä** –∏ **–û–Ω–ª–∞–π–Ω –ß–∞—Ç**! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ "–û–Ω–ª–∞–π–Ω –ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏", —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∏–≥—Ä—É.</p>
                <p>–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º –≤ –ø–æ–ª–µ –Ω–∏–∂–µ, –æ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —á–∞—Ç–µ –∏ –≤ –∏–≥—Ä–µ.</p>
                <p>
                    <label for="userName" style="color:#ffff00;">–í–∞—à –ù–∏–∫–Ω–µ–π–º:</label>
                    <input type="text" id="userName" value="–ì–æ—Å—Ç—å" style="padding: 5px; border: 2px solid #00ffff; background-color: #000000; color: #ffffff;">
                    <button onclick="setUserName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </p>
            </div>

            <div id="tictactoe_game" class="game-section">
                <h2>‚öîÔ∏è –û–Ω–ª–∞–π–Ω –ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏</h2>
                <p>–ù–∞–π–¥–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∏–≥—Ä—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ!</p>
                
                <div id="lobbyControls">
                    <button onclick="createGame()">–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—É—é –ò–≥—Ä—É</button>
                    <button onclick="joinRandomGame()">–ù–∞–π—Ç–∏ –°–ª—É—á–∞–π–Ω—É—é –ò–≥—Ä—É</button>
                    <input type="text" id="gameIdInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã">
                    <button onclick="joinGameById()">–í–æ–π—Ç–∏ –ø–æ ID</button>
                    <p id="currentGameInfo" class="result" style="color: #00ffff;">
                        –°—Ç–∞—Ç—É—Å: –ù–µ –≤ –∏–≥—Ä–µ.
                    </p>
                </div>
                
                <div id="gameArea" style="display: none;">
                    <p id="playerRole" style="font-size: 18px; font-weight: bold;"></p>
                    <div id="tictactoe-board"></div>
                    <div id="tictactoeResult" class="result">
                        –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...
                    </div>
                    <button onclick="leaveGame()">–ü–æ–∫–∏–Ω—É—Ç—å –ò–≥—Ä—É</button>
                    <button onclick="resetGame()">–ù–∞—á–∞—Ç—å –ó–∞–Ω–æ–≤–æ</button>
                </div>
            </div>

            <div id="rps_game" class="game-section">
                <h2>‚úÇÔ∏è –ö–∞–º–µ–Ω—å, –ù–æ–∂–Ω–∏—Ü—ã, –ë—É–º–∞–≥–∞ (–õ–æ–∫–∞–ª—å–Ω—ã–π)</h2>
                <p>–°—ã–≥—Ä–∞–π —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º! –í—ã–±–µ—Ä–∏ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:</p>
                
                <div>
                    <button onclick="playRPS('rock')">–ö–ê–ú–ï–ù–¨ üëä</button>
                    <button onclick="playRPS('paper')">–ë–£–ú–ê–ì–ê ‚úã</button>
                    <button onclick="playRPS('scissors')">–ù–û–ñ–ù–ò–¶–´ ‚úåÔ∏è</button>
                </div>
                
                <div id="rpsResult" class="result">
                    –°—á–µ—Ç: –ò–≥—Ä–æ–∫ 0 - –ö–æ–º–ø—å—é—Ç–µ—Ä 0
                </div>
                <p>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ö–æ–¥: <span id="rpsLastMove">---</span></p>
            </div>

            <div id="reaction_test" class="game-section">
                <h2>‚ö° –ü—Ä–æ–≤–µ—Ä—å —Å–∫–æ—Ä–æ—Å—Ç—å –ö–õ–ò–ö–ê! (–õ–æ–∫–∞–ª—å–Ω—ã–π)</h2>
                <p>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É **"–ù–∞—á–∞—Ç—å"**, –∑–∞—Ç–µ–º –∂–¥–∏. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –∫–≤–∞–¥—Ä–∞—Ç —Å—Ç–∞–Ω–µ—Ç **–ó–ï–õ–ï–ù–´–ú**, –∫–ª–∏–∫–Ω–∏ –ø–æ –Ω–µ–º—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ!</p>
                
                <button id="reactionStartButton">–ù–∞—á–∞—Ç—å –¢–µ—Å—Ç</button>
                
                <div id="reactionTarget" class="wait">–ñ–î–ò</div>
                
                <div id="reactionResult" class="result">
                    –õ—É—á—à–µ–µ –≤—Ä–µ–º—è: –ù/–î
                </div>
            </div>
            
            <div id="online_chat" class="game-section">
                <h2>üí¨ –û–Ω–ª–∞–π–Ω –§–æ—Ä—É–º–Ω—ã–π –ß–∞—Ç</h2>
                <p>–û–±—â–∞–π—Ç–µ—Å—å —Å–æ –≤—Å–µ–º–∏, –∫—Ç–æ —Å–µ–π—á–∞—Å –Ω–∞ –ø–æ—Ä—Ç–∞–ª–µ! <span style="color:#ff00ff;">(–°–æ–æ–±—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!)</span></p>
                
                <div id="chat-window">
                    </div>
                
                <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width: 70%; padding: 8px; background-color: #ffcccc; border: 3px solid #ff0000;">
                <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <p style="font-size: 10px; color: #c0c0c0;">–í–∞—à –Ω–∏–∫–Ω–µ–π–º: <span id="displayUserName">–ì–æ—Å—Ç—å</span></p>
            </div>

        </main>
    </div>

    <div class="ad-banner" onclick="document.location.href='https://youtu.be/dQw4w9WgXcQ?si=1UrBcdRcMO3CrQBP'">
        <span class="gif-decoration">üí∞</span> –ö–õ–ò–ö–ù–ò –ò –í–´–ò–ì–†–ê–ô –ú–ò–õ–õ–ò–û–ù –î–û–õ–õ–ê–†–û–í! <span class="gif-decoration">ü§ë</span> <span style="color:#00ffff;">(–°–£–ü–ï–†-–ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï!)</span>
    </div>


    <marquee direction="left" behavior="alternate" style="color:#ffff00; font-size: 16px; margin-top: 20px;">
        *** –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ 7DialsWeb! –ú—ã –∂–¥–µ–º –≤–∞—à–∏—Ö –Ω–æ–≤—ã—Ö —Ä–µ–∫–æ—Ä–¥–æ–≤! ***
    </marquee>


    <script>
        // --- 0.1. –ê–£–î–ò–û–°–ò–°–¢–ï–ú–ê (Web Audio API) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let isMusicPlaying = false;
        const toggleMusicButton = document.getElementById('toggleMusicButton');
        let musicTimeoutId;
        let USER_NAME = localStorage.getItem('userName') || '–ì–æ—Å—Ç—å';

        document.getElementById('userName').value = USER_NAME;
        document.getElementById('displayUserName').textContent = USER_NAME;

        function setUserName() {
            USER_NAME = document.getElementById('userName').value.trim() || '–ì–æ—Å—Ç—å';
            localStorage.setItem('userName', USER_NAME);
            document.getElementById('displayUserName').textContent = USER_NAME;
            SOUNDS.CLICK();
            alert(`–ù–∏–∫–Ω–µ–π–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${USER_NAME}`);
        }

        function playSound(frequency, duration, type = 'square', volume = 0.5) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime); 
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration);
        }

        const SOUNDS = {
            CLICK: () => playSound(880, 0.05, 'square', 0.4), 
            WIN: () => { playSound(660, 0.1); playSound(990, 0.2, 'triangle'); },
            LOSE: () => { playSound(150, 0.2, 'sawtooth', 0.6); playSound(100, 0.2, 'sawtooth', 0.6); },
            MOVE: () => playSound(440, 0.08, 'sine', 0.3)
        };
        
        // --- –§–û–ù–û–í–ê–Ø –ú–£–ó–´–ö–ê (–ù–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω) ---
        const MUSIC_PATTERN = [
            392, 0.4, 440, 0.2, 494, 0.2, 
            392, 0.8, 330, 0.4, 
            440, 0.4, 523, 0.4, 
            494, 0.8, 392, 0.4,
            0, 0.8 
        ];
        let musicNoteIndex = 0;
        
        function playNote(freq, duration, type = 'sine') {
            if (freq === 0) return;
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime); 
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration * 0.95);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration);
        }

        function playBackgroundMusic() {
            if (isMusicPlaying) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            isMusicPlaying = true;
            toggleMusicButton.textContent = 'üîà –í—ã–∫–ª. –ú—É–∑—ã–∫—É';
            
            const playNextNote = () => {
                 if (!isMusicPlaying) return;
                 
                 const freq = MUSIC_PATTERN[musicNoteIndex];
                 const duration = MUSIC_PATTERN[musicNoteIndex + 1];

                 playNote(freq, duration, 'sine'); 

                 musicNoteIndex = (musicNoteIndex + 2) % MUSIC_PATTERN.length;
                 musicTimeoutId = setTimeout(playNextNote, duration * 1000);
            };
            
            musicNoteIndex = 0; 
            playNextNote();
        }

        function toggleMusic() {
            if (isMusicPlaying) {
                isMusicPlaying = false;
                clearTimeout(musicTimeoutId);
                toggleMusicButton.textContent = 'üîä –í–∫–ª. –ú—É–∑—ã–∫—É';
            } else {
                playBackgroundMusic();
            }
        }
        
        toggleMusicButton.addEventListener('click', toggleMusic);
        
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∑–≤—É–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
        document.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }, { once: true });


        // --- 0.2. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –ö–õ–Æ–ß–ò) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1FHjNtG0yLCzTAqHOiXiJBOQd7_kLOJM",
            authDomain: "web-84026.firebaseapp.com",
            databaseURL: "https://web-84026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "web-84026",
            storageBucket: "web-84026.firebasestorage.app",
            messagingSenderId: "22249639918",
            appId: "1:22249639918:web:f804a6fe19d9e2c7f8c8ff"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        
        // --- 0.3. –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        const sidebarButtons = document.querySelectorAll('.sidebar button');
        const gameSections = document.querySelectorAll('.game-section');

        function switchPage(pageId) {
            SOUNDS.CLICK(); 
            gameSections.forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(pageId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            sidebarButtons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.target === pageId) {
                    button.classList.add('active');
                }
            });
        }

        sidebarButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchPage(button.dataset.target);
            });
        });


        // --- 1. –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† –ö–†–ï–°–¢–ò–ö–ò-–ù–û–õ–ò–ö–ò (TIC-TAC-TOE) ---
        
        const gameArea = document.getElementById('gameArea');
        const lobbyControls = document.getElementById('lobbyControls');
        const tictactoeBoard = document.getElementById('tictactoe-board');
        const tictactoeResultDiv = document.getElementById('tictactoeResult');
        const currentGameInfo = document.getElementById('currentGameInfo');
        const playerRole = document.getElementById('playerRole');

        let currentRoomRef = null;
        let myPlayerId = 'P' + Date.now(); // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
        let myRole = null; // 'X' –∏–ª–∏ 'O'

        const WINNING_COMBOS = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]            
        ];
        
        function generateGameId() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function displayLobby() {
            gameArea.style.display = 'none';
            lobbyControls.style.display = 'block';
            currentGameInfo.textContent = '–°—Ç–∞—Ç—É—Å: –ù–µ –≤ –∏–≥—Ä–µ.';
            tictactoeBoard.innerHTML = '';
        }

        function displayGameArea(message) {
            gameArea.style.display = 'block';
            lobbyControls.style.display = 'none';
            tictactoeResultDiv.textContent = message;
        }

        function createGame() {
            SOUNDS.CLICK();
            const gameId = generateGameId();
            currentRoomRef = database.ref('games/' + gameId);
            myRole = 'X';
            
            const initialGameState = {
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'X',
                playerX: USER_NAME, // Player X is the creator
                playerO: '–û–∂–∏–¥–∞–Ω–∏–µ...',
                winner: null,
                status: 'waiting'
            };

            currentRoomRef.set(initialGameState);
            setupGameListener(gameId);
            displayGameArea('–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ O... ID –∫–æ–º–Ω–∞—Ç—ã: ' + gameId);
            playerRole.textContent = `–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞: X (${USER_NAME})`;
        }

        function joinGame(gameId) {
             SOUNDS.CLICK();
             currentRoomRef = database.ref('games/' + gameId);
             
             currentRoomRef.once('value', (snapshot) => {
                 const game = snapshot.val();
                 if (!game || game.status !== 'waiting') {
                     alert('–û—à–∏–±–∫–∞: –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–Ω—è—Ç–∞!');
                     currentRoomRef = null;
                     return;
                 }
                 
                 myRole = 'O';
                 currentRoomRef.update({ 
                    playerO: USER_NAME,
                    status: 'active'
                 });
                 
                 setupGameListener(gameId);
                 displayGameArea('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –•–æ–¥ –∏–≥—Ä–æ–∫–∞ X.');
                 playerRole.textContent = `–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞: O (${USER_NAME})`;
             });
        }
        
        function joinGameById() {
            const gameId = document.getElementById('gameIdInput').value.trim().toUpperCase();
            if (gameId) {
                joinGame(gameId);
            }
        }
        
        function joinRandomGame() {
             SOUNDS.CLICK();
             database.ref('games').orderByChild('status').equalTo('waiting').limitToFirst(1)
                .once('value', (snapshot) => {
                    const games = snapshot.val();
                    if (games) {
                        const gameId = Object.keys(games)[0];
                        joinGame(gameId);
                    } else {
                        alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é!');
                    }
                });
        }

        function leaveGame() {
            if (currentRoomRef) {
                // –ï—Å–ª–∏ –º—ã X –∏ –∏–≥—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø–æ–º–µ—á–∞–µ–º –µ–µ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
                if (myRole === 'X' && tictactoeResultDiv.textContent.includes('–•–æ–¥')) {
                     currentRoomRef.update({ winner: 'O (Disconnection)', status: 'finished' });
                }
                // –û—Ç–∫–ª—é—á–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å
                currentRoomRef.off();
                currentRoomRef = null;
                myRole = null;
                displayLobby();
            }
        }

        function setupGameListener(gameId) {
            currentGameInfo.textContent = `–ö–æ–º–Ω–∞—Ç–∞ ID: ${gameId}`;
            
            currentRoomRef.on('value', (snapshot) => {
                const game = snapshot.val();
                if (!game) {
                    alert('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞.');
                    currentRoomRef.off();
                    displayLobby();
                    return;
                }
                updateGameUI(game);
            });
            displayGameArea('–û–∂–∏–¥–∞–Ω–∏–µ...');
            renderBoard([]);
        }

        function renderBoard(boardData) {
            tictactoeBoard.innerHTML = ''; 
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.setAttribute('data-index', i);
                cell.textContent = boardData[i] || '';
                cell.style.color = (boardData[i] === 'X' ? '#ff0000' : '#00ffff');
                if (boardData[i]) cell.classList.add('occupied');
                cell.addEventListener('click', handleCellClick);
                tictactoeBoard.appendChild(cell);
            }
        }
        
        function checkWinner(board) {
            for (const [a, b, c] of WINNING_COMBOS) {
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a]; 
                }
            }
            if (board.every(cell => cell !== '')) {
                return 'Draw';
            }
            return null;
        }

        function updateGameUI(game) {
            renderBoard(game.board);
            
            if (game.status === 'waiting') {
                tictactoeResultDiv.textContent = `–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ O... (ID: ${currentGameInfo.textContent.split(': ')[1]})`;
                if (myRole === 'X') {
                    playerRole.textContent = `–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞: X (${game.playerX}) | –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å ID: ${currentGameInfo.textContent.split(': ')[1]}`;
                }
            } else if (game.status === 'active') {
                const isMyTurn = game.currentPlayer === myRole;
                tictactoeResultDiv.textContent = isMyTurn ? `–í–ê–® –•–û–î (${myRole})` : `–•–æ–¥ –∏–≥—Ä–æ–∫–∞ ${game.currentPlayer}`;
            }

            if (game.winner) {
                tictactoeResultDiv.textContent = `–ò–ì–†–ê –ó–ê–í–ï–†–®–ï–ù–ê! –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${game.winner}`;
                game.status = 'finished';
                if (game.winner === myRole) {
                    SOUNDS.WIN();
                } else if (game.winner === 'Draw') {
                    // –ù–∏—á—å—è
                } else {
                    SOUNDS.LOSE();
                }
            }
            // –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
            if (game.winner && game.winner !== 'Draw' && game.status === 'finished') {
                const winningCells = WINNING_COMBOS.find(([a, b, c]) => 
                    game.board[a] === game.winner && game.board[b] === game.winner && game.board[c] === game.winner
                );
                if (winningCells) {
                    winningCells.forEach(index => {
                        tictactoeBoard.querySelector(`[data-index="${index}"]`).classList.add('win');
                    });
                }
            }

        }

        function handleCellClick(event) {
            const index = parseInt(event.target.getAttribute('data-index'));
            
            currentRoomRef.once('value', (snapshot) => {
                const game = snapshot.val();
                
                if (!game || game.status !== 'active' || game.currentPlayer !== myRole || game.board[index] !== '') {
                    // –ù–µ –Ω–∞—à —Ö–æ–¥, –∏–≥—Ä–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –∏–ª–∏ –∫–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞
                    return; 
                }
                
                SOUNDS.MOVE();
                const newBoard = [...game.board];
                newBoard[index] = myRole;
                
                const winner = checkWinner(newBoard);
                let nextPlayer = myRole === 'X' ? 'O' : 'X';
                let winnerMessage = null;
                let newStatus = 'active';

                if (winner) {
                    winnerMessage = winner === 'Draw' ? 'Draw' : winner;
                    newStatus = 'finished';
                    nextPlayer = null; // –°—Ç–æ–ø —Ö–æ–¥
                }

                currentRoomRef.update({
                    board: newBoard,
                    currentPlayer: nextPlayer,
                    winner: winnerMessage,
                    status: newStatus
                });
            });
        }
        
        function resetGame() {
            if (!currentRoomRef || myRole !== 'X') {
                 alert('–¢–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫ X –º–æ–∂–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É!');
                 return;
            }
            SOUNDS.CLICK();
            currentRoomRef.once('value', (snapshot) => {
                const game = snapshot.val();
                if (game) {
                    currentRoomRef.update({
                        board: ['', '', '', '', '', '', '', '', ''],
                        currentPlayer: 'X',
                        winner: null,
                        status: 'active'
                    });
                }
            });
        }


        // --- 2. –û–ù–õ–ê–ô–ù –ß–ê–¢ (–§–û–†–£–ú) ---
        
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chatInput');
        const chatRef = database.ref('chat');

        function sendMessage() {
            SOUNDS.CLICK();
            const text = chatInput.value.trim();
            if (text === '') return;
            
            const newMessage = {
                user: USER_NAME,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            chatRef.push(newMessage);
            chatInput.value = '';
        }

        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        chatRef.limitToLast(20).on('child_added', (snapshot) => {
            const message = snapshot.val();
            const date = new Date(message.timestamp);
            const timeString = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            
            const sanitizedText = message.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            messageDiv.innerHTML = `
                <span class="chat-timestamp">${timeString}</span>
                <strong>${message.user}:</strong> ${sanitizedText}
            `;
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        });


        // --- 3. –õ–û–ö–ê–õ–¨–ù–´–ï –ò–ì–†–´ (–û—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) ---

        // --- 3.1. –ö–∞–º–µ–Ω—å, –ù–æ–∂–Ω–∏—Ü—ã, –ë—É–º–∞–≥–∞ (RPS) ---
        let rpsScore = { player: 0, computer: 0 };
        const rpsResultDiv = document.getElementById('rpsResult');
        const rpsLastMoveSpan = document.getElementById('rpsLastMove');
        const rpsChoices = ['rock', 'paper', 'scissors'];
        const rpsEmotes = { rock: 'üëä', paper: '‚úã', scissors: '‚úåÔ∏è' };

        function getComputerChoice() {
            const randomIndex = Math.floor(Math.random() * 3);
            return rpsChoices[randomIndex];
        }

        function playRPS(playerChoice) {
            SOUNDS.CLICK(); 
            const computerChoice = getComputerChoice();
            let resultMessage = "";
            rpsLastMoveSpan.textContent = `–ò–≥—Ä–æ–∫ ${rpsEmotes[playerChoice]} vs –ö–æ–º–ø—å—é—Ç–µ—Ä ${rpsEmotes[computerChoice]}`;

            if (playerChoice === computerChoice) {
                resultMessage = "–ù–ò–ß–¨–Ø! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.";
            } else if (
                (playerChoice === 'rock' && computerChoice === 'scissors') ||
                (playerChoice === 'paper' && computerChoice === 'rock') ||
                (playerChoice === 'scissors' && computerChoice === 'paper')
            ) {
                rpsScore.player++;
                resultMessage = "–ü–û–ë–ï–î–ê –ò–ì–†–û–ö–ê! –¢—ã –∫—Ä—É—Ç!";
                SOUNDS.WIN();
            } else {
                rpsScore.computer++;
                resultMessage = "–ü–û–ë–ï–î–ê –ö–û–ú–ü–¨–Æ–¢–ï–†–ê! –ù–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è.";
                SOUNDS.LOSE();
            }
            rpsResultDiv.innerHTML = `${resultMessage} <br> –°—á–µ—Ç: –ò–≥—Ä–æ–∫ ${rpsScore.player} - –ö–æ–º–ø—å—é—Ç–µ—Ä ${rpsScore.computer}`;
        }
        
        // --- 3.2. –ö–ª–∏–∫-–¢–µ—Å—Ç (Reaction Time Test) ---
        const reactionStartButton = document.getElementById('reactionStartButton');
        const reactionTarget = document.getElementById('reactionTarget');
        const reactionResultDiv = document.getElementById('reactionResult');
        let startTime;
        let timeoutId;
        let isWaiting = false;
        let isReady = false;
        let bestTime = localStorage.getItem('bestReactionTime') || '–ù/–î';

        reactionResultDiv.innerHTML = `–õ—É—á—à–µ–µ –≤—Ä–µ–º—è: ${bestTime} –º—Å`;

        function startReactionTest() {
            if (isWaiting || isReady) return;
            SOUNDS.CLICK();
            reactionStartButton.disabled = true;
            reactionTarget.className = 'wait';
            reactionTarget.textContent = '–ñ–î–ò...';
            isWaiting = true;
            isReady = false;
            const delay = Math.random() * 3000 + 1500; 

            timeoutId = setTimeout(() => {
                reactionTarget.className = 'click-now';
                reactionTarget.textContent = '–ö–õ–ò–ö–ê–ô!';
                isReady = true;
                isWaiting = false;
                startTime = Date.now();
            }, delay);
        }

        function handleReactionClick() {
            if (isWaiting) {
                clearTimeout(timeoutId);
                reactionTarget.className = '';
                reactionTarget.textContent = '–°–õ–ò–®–ö–û–ú –†–ê–ù–û!';
                reactionResultDiv.textContent = '–û–®–ò–ë–ö–ê: –í—ã –∫–ª–∏–∫–Ω—É–ª–∏ —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                reactionStartButton.disabled = false;
                isWaiting = false;
                isReady = false;
                SOUNDS.LOSE();
            } else if (isReady) {
                const endTime = Date.now();
                const reactionTime = endTime - startTime;
                reactionTarget.className = '';
                reactionTarget.textContent = `${reactionTime} –º—Å`;
                reactionStartButton.disabled = false;
                isReady = false;
                
                let message = `–í–∞—à–µ –≤—Ä–µ–º—è: ${reactionTime} –º—Å.`;
                if (bestTime === '–ù/–î' || reactionTime < parseFloat(bestTime)) {
                    bestTime = reactionTime.toString();
                    localStorage.setItem('bestReactionTime', bestTime);
                    message += ' –ù–û–í–´–ô –†–ï–ö–û–†–î! üî•';
                    SOUNDS.WIN();
                }
                reactionResultDiv.innerHTML = `${message} <br> –õ—É—á—à–µ–µ –≤—Ä–µ–º—è: ${bestTime} –º—Å`;
            } else {
                 reactionResultDiv.textContent = '–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –¢–µ—Å—Ç", —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å!';
            }
        }

        reactionStartButton.addEventListener('click', startReactionTest);
        reactionTarget.addEventListener('click', handleReactionClick);


    </script>
</body>
</html>